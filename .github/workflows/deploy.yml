name: Deploy Plugin

on:
  workflow_run:
    workflows: ["Bump Plugin Version"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PRODUCTION_SERVER_USERNAME: ${{ secrets.PRODUCTION_SERVER_USERNAME }}
      PRODUCTION_SERVER_PASSWORD: ${{ secrets.PRODUCTION_SERVER_PASSWORD }}
      PRODUCTION_SERVER_HOST: ${{ secrets.PRODUCTION_SERVER_HOST }}
    steps:
      - uses: actions/checkout@v3

      - name: Build plugin
        run: ./gradlew buildPlugin

      - name: Copy build to server
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ env.PRODUCTION_SERVER_HOST }}
          username: ${{ env.PRODUCTION_SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: build/distributions/*.zip
          target: /var/www/intellij-plugins/  # Ispravka ovde

      - name: Update updatePlugins.xml
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.PRODUCTION_SERVER_HOST }}
          username: ${{ secrets.PRODUCTION_SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            LATEST_ZIP=$(ls -t /var/www/intellij-plugins/build/distributions/nastavnicki-plugin-*.zip | head -n 1)
            VERSION=$(basename "$LATEST_ZIP" | sed -E 's/nastavnicki-plugin-(.*)\.zip/\1/')
            PLUGIN_URL="http://157.180.37.247/build/distributions/$(basename "$LATEST_ZIP")"
            
            xmlstarlet ed \
              --subnode "/plugins" --type elem -n "plugin" -v "" \
              --insert "/plugins/plugin[last()]" --type attr -n "id" -v "com.raf.nastavnicki" \
              --insert "/plugins/plugin[last()]" --type attr -n "url" -v "$PLUGIN_URL" \
              --insert "/plugins/plugin[last()]" --type attr -n "version" -v "$VERSION" \
              ... # Ostale XML komande ostaju iste
            /var/www/intellij-plugins/updatePlugins.xml > /tmp/update_temp.xml
            
            mv /tmp/update_temp.xml /var/www/intellij-plugins/updatePlugins.xml