name: Deploy Plugin to GitHub Pages

on:
  push:
    branches:
      - main  # PokreÄ‡e se samo kada se izvrÅ¡i push na main granu

jobs:
  deploy:
    name: Build and Deploy Plugin
    runs-on: windows-latest  # Mora biti Windows jer koristiÅ¡ lokalni folder

    steps:
      # ğŸ“ Kloniraj repozitorijum gde se nalazi plugin kod
      - name: Checkout plugin repository
        uses: actions/checkout@v4

      # ğŸ§° Postavi JDK
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # âš™ï¸ Gradle build
      - name: Build with Gradle
        run: ./gradlew build

      # ğŸ“‹ Prikaz build artefakata za debug
      - name: List built files
        run: |
          if (!(Test-Path -Path "build/distributions")) {
            Write-Error "Build folder does not exist!"
            exit 1
          } else {
            Write-Output "âœ… Build folder found. Listing contents:"
            Get-ChildItem -Recurse build/distributions
          }
        shell: pwsh

      # ğŸ“‚ Kopiraj build u drugi folder (simulacija deploy)
      - name: Copy build to deploy directory
        run: |
          $source = "build/distributions/raf-teacher-plugin.zip"
          $destination = "C:\\Users\\Zarko\\mojiPlugins\\nastavnicki\\NastavniÄki Plugin - RAF-2.0.2.zip"

          if (!(Test-Path $source)) {
            Write-Error "Zip file not found at: $source"
            exit 1
          }

          Write-Output "Copying $source to $destination"
          Copy-Item -Path $source -Destination $destination -Force
        shell: pwsh

      # ğŸŒ Kloniraj zarko.github.io repo
      - name: Clone GitHub Pages repo
        run: |
          git clone https://github.com/zarko-ned/zarko.github.io.git zarko-gh-pages
        shell: pwsh

      # ğŸ“ Kopiraj fajl u odgovarajuÄ‡i folder
      - name: Move plugin to GitHub Pages repo
        run: |
          $src = "build/distributions/raf-teacher-plugin.zip"
          $dst = "zarko-gh-pages/nastavnicki/NastavniÄki Plugin - RAF-2.0.2.zip"

          if (!(Test-Path $src)) {
            Write-Error "Build ZIP not found!"
            exit 1
          }

          Copy-Item -Path $src -Destination $dst -Force
          Write-Output "Plugin successfully copied to GitHub Pages repo"
        shell: pwsh

      # ğŸš€ Push na zarko.github.io
      - name: Commit and push to GitHub Pages
        run: |
          cd zarko-gh-pages
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "ğŸš€ Auto deploy: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GH_PAT }}@github.com/zarko-ned/zarko.github.io.git main
        shell: pwsh
