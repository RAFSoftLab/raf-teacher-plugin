name: Deploy Plugin to GitHub Pages

on:
  push:
    branches:
      - main
    paths:
      - 'build/distributions/**'

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Log current directory and files
        run: |
          Write-Host "Listing root folder content:"
          Get-ChildItem -Recurse

      - name: Create target folder (if not exists)
        run: |
          $path = "gh-pages/nastavnicki"
          if (!(Test-Path -Path $path)) {
            New-Item -ItemType Directory -Path $path -Force
          } else {
            Write-Host "$path already exists"
          }

      - name: Copy plugin ZIP to target
        run: |
          Copy-Item "build/distributions/*.zip" "gh-pages/nastavnicki/" -Force
          Write-Host "Copied ZIPs to gh-pages/nastavnicki"

      - name: Init Git, commit and push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add .
          
          # Log whatâ€™s staged
          git diff --cached
          
          # Check if there's anything to commit
          git diff --cached --quiet
          if ($LASTEXITCODE -eq 0) {
            Write-Host "No changes to commit"
          } else {
            git commit -m "Update plugin version"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/zarko-ned/zarko.github.io.git main
          }
